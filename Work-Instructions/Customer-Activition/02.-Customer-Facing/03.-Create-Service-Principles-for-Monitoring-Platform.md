## Overview
This section describes the creation of the service principles required for the monitoring platform. For each environment these steps need to be repeated. So if the customer has 2 production environments (US & Asia) and 1 UAT environment these steps need to be repeated 2 times. 

## Output
The output of these steps will create a Service Principles in the Azure AD tenant and assigns these principles to an Azure role. IDs and secrets are securely stored in a Key Vault. The following principles is created:

| Principle | Role | Mandatory | Certificate* | Purpose | Example | 
|---|---|---|---|---|---|
|`MonitoringAgent-$environment-$serviceId-$spnSuffix` | Contributor | Yes | Yes | This SPN is used to execute predefined runbooks by Azure Automation. |MonitoringAgent-DEV-BPL-SPN|
*Certificates are created as past of this section


###Roles

The following are the roles required to be part of the Service Principle
```
*/read
Microsoft.AlertsManagement/*
Microsoft.Authorization/*/read
Microsoft.Automation/automationAccounts/jobs/*
Microsoft.Compute/virtualMachines/extensions/*
Microsoft.Compute/virtualMachineScaleSets/extensions/*
Microsoft.Insights/*
Microsoft.OperationalInsights/workspaces/*
Microsoft.ResourceHealth/availabilityStatuses/read
Microsoft.Security/*/read
Microsoft.Sql/servers/auditingPolicies/*
Microsoft.Sql/servers/auditingSettings/*
Microsoft.Sql/servers/databases/auditingPolicies/*
Microsoft.Sql/servers/databases/auditingSettings/*
Microsoft.Sql/servers/databases/auditRecords/read
Microsoft.Sql/servers/databases/connectionPolicies/*
Microsoft.Sql/servers/databases/dataMaskingPolicies/*
Microsoft.Sql/servers/databases/securityAlertPolicies/*
Microsoft.Sql/servers/databases/securityMetrics/*
Microsoft.Sql/servers/databases/vulnerabilityAssessments/*
Microsoft.Sql/servers/databases/vulnerabilityAssessmentScans/*
Microsoft.Sql/servers/databases/vulnerabilityAssessmentSettings/*
Microsoft.Sql/servers/securityAlertPolicies/*
Microsoft.Storage/storageAccounts/*
Microsoft.WorkloadMonitor/workloads/*
```

## Prerequisites
In order to proceed, the following items need to be available or in place:
- List of environments (short names) need to be available.
- Is Kusto required for customers solution. 
- Key Vault name storing SPN details (contact ess-monitoring@microsoft.com)
- Service ID representing the service (contact ess-monitoring@microsoft.com)
- Temporary access to Key Vault (contact ess-monitoring@microsoft.com)
- Local Admin right on PC is required.
- Azure Owner permissions for targeted environments.  

## Activities
The following activities need to be performed:
- Download the latest version of the [SPN validation and creation script](https://easplatform.visualstudio.com/_git/Monitoring?path=%2Fsrc%2FMicrosoft.EAS.Monitoring.Deployment.Platform%2FPre-SpnCreationAndValidation.ps1&version=GBmaster).
- Open PowerShell console with elevated permission (Run as Administrator)
- Login to Azure using own Account: `Login-AzureRmAccount`

Perform for each environment:
- Select the subscription of that environment: `Select-RmSubscription -SubscriptionId {guid}`
- Execute scripts: `Pre-SpnCreationAndValidation.ps1 -keyVaultName {string} -environment {string} -serviceId {string} -kustoEnabled {bool}`
