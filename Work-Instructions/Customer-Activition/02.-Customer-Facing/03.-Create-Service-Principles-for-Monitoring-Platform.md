## Overview

This section describes the creation of the service principle required for the monitoring platform. For each environment these steps need to be repeated. So if the customer has 2 production environments (US & Asia) and 1 UAT environment these steps need to be repeated 2 times.

## Output

The output of these steps will create a Service Principle in the Azure AD tenant and assigns the principle to an custom Azure role. The created App ID, certificate and secret are securely stored in a ESS Key Vault dedicated for the customer. The following principle is created:

| Principle | Role | Mandatory | Certificate | Purpose | Example |
|---|---|---|---|---|---|
|`SPN-MonitoringAgent-$environment-$serviceId` | Custom* | Yes | Yes | This SPN is used to configure monitoring setting for in-scope resources and query logs from data sources. |SPN-MonitoringAgent-PROD-BPL-MON|
*See roles section below for scope.

## Roles

The following permissions are required for the Service Principal. These permission will be created as part of a custom Azure role (ESS Monitoring Agent) and assigned to the created SPN.
```
*/read
Microsoft.AlertsManagement/*
Microsoft.Authorization/*/read
Microsoft.Automation/automationAccounts/jobs/*
Microsoft.Compute/virtualMachines/extensions/*
Microsoft.Compute/virtualMachineScaleSets/extensions/*
Microsoft.Insights/*
Microsoft.OperationalInsights/workspaces/*
Microsoft.ResourceHealth/availabilityStatuses/read
Microsoft.Security/*/read
Microsoft.Sql/servers/auditingPolicies/*
Microsoft.Sql/servers/auditingSettings/*
Microsoft.Sql/servers/databases/auditingPolicies/*
Microsoft.Sql/servers/databases/auditingSettings/*
Microsoft.Sql/servers/databases/auditRecords/read
Microsoft.Sql/servers/databases/connectionPolicies/*
Microsoft.Sql/servers/databases/dataMaskingPolicies/*
Microsoft.Sql/servers/databases/securityAlertPolicies/*
Microsoft.Sql/servers/databases/securityMetrics/*
Microsoft.Sql/servers/databases/vulnerabilityAssessments/*
Microsoft.Sql/servers/databases/vulnerabilityAssessmentScans/*
Microsoft.Sql/servers/databases/vulnerabilityAssessmentSettings/*
Microsoft.Sql/servers/securityAlertPolicies/*
Microsoft.Storage/storageAccounts/*
Microsoft.WorkloadMonitor/workloads/*
```

## Prerequisites

In order to proceed, the following items need to be available or in place:

- List of environments (short names) need to be available.
- Key Vault name storing SPN details (contact ess-monitoring@microsoft.com)
- Service ID representing the service (contact ess-monitoring@microsoft.com)
- Temporary access to Key Vault (contact ess-monitoring@microsoft.com)
- Azure Owner permissions to grant SPN and customer role approve access.

## Activities

The following activities need to be performed:

- Download the latest version of the [SPN validation and creation script](https://easplatform.visualstudio.com/_git/Monitoring?path=%2Fsrc%2FMicrosoft.EAS.Monitoring.Deployment.Platform%2FPre-SpnCreationAndValidation.ps1&version=GBmaster).
- Open a PowerShell console (with [Azure PowerShell](https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps) installed)
- Login to Azure using account with Owner permissions: `Login-AzureRmAccount`

Perform for each environment:

- Select the subscription of that environment: `Select-RmSubscription -SubscriptionId {guid}` (or `get-azurermsubscription -subscriptionname "<subscription name>" | set-azurermcontext`)
- Execute script: `Pre-SpnCreationAndValidation.ps1 -keyVaultName {string} -environment {string} -serviceId {string} -integrationSpnSecret {string}`

**Note** Someone from the ESS monitoring will provide Key Vault name, Service ID and Integration SPN Secret.
